<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Training - Cyber Safer</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .scenario-guide {
      background: linear-gradient(135deg, #1a1f2e, #16213e);
      border: 1px solid var(--accent);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .scenario-guide h3 {
      margin: 0 0 1rem 0;
      color: var(--accent);
      font-size: 1.1rem;
    }

    .guide-section {
      margin: 0.75rem 0;
    }

    .guide-section strong {
      color: var(--fg);
      display: block;
      margin-bottom: 0.3rem;
    }

    .guide-section ul {
      margin: 0.5rem 0;
      padding-left: 1.5rem;
      color: #8b949e;
    }

    .guide-section li {
      margin: 0.3rem 0;
    }

    .flag-hint {
      background: rgba(88, 166, 255, 0.1);
      border-left: 3px solid var(--accent);
      padding: 0.75rem;
      margin: 0.5rem 0;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .flag-detected {
      background: rgba(63, 185, 80, 0.15);
      border-left: 3px solid var(--success);
      padding: 0.75rem;
      margin: 0.5rem 0;
      border-radius: 4px;
      color: var(--success);
      font-size: 0.9rem;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .toggle-guide {
      background: transparent;
      border: 1px solid var(--accent);
      color: var(--accent);
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }

    .toggle-guide:hover {
      background: rgba(88, 166, 255, 0.1);
    }

    /* Modal for confirmation */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: #161b22;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 2rem;
      max-width: 400px;
      width: 90%;
    }

    .modal-content h3 {
      margin-top: 0;
      color: var(--accent);
    }

    .modal-buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 1.5rem;
    }

    .modal-buttons button {
      flex: 1;
    }

    /* Progress indicator */
    .progress-bar {
      background: #0d1117;
      height: 4px;
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 1rem;
    }

    .progress-fill {
      background: linear-gradient(90deg, var(--accent), var(--success));
      height: 100%;
      width: 0%;
      transition: width 0.3s ease;
    }

    .interaction-stats {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem;
      background: #0d1117;
      border-radius: 6px;
      margin-bottom: 1rem;
      font-size: 0.85rem;
      color: #8b949e;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .stat-value {
      color: var(--accent);
      font-weight: 600;
    }
  </style>
</head>
<body>
  <header>
    <a href="/" class="logo">üõ°Ô∏è Cyber Safer</a>
    <span class="mode-indicator" id="categoryName"></span>
  </header>

  <main style="padding: 0;">
    <div class="chat-container">
      <!-- Progress and Stats -->
      <div style="padding: 1rem; padding-bottom: 0;">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="interaction-stats">
          <div class="stat-item">
            <span>Messages:</span>
            <span class="stat-value" id="messageCount">0</span>
          </div>
          <div class="stat-item">
            <span>Red Flags Found:</span>
            <span class="stat-value" id="flagCount">0/0</span>
          </div>
        </div>
      </div>

      <!-- Scenario Guide -->
      <div style="padding: 0 1rem;">
        <button class="toggle-guide" id="toggleGuide">üìã Show/Hide Training Guide</button>
        <div class="scenario-guide" id="scenarioGuide">
          <h3>üéØ Your Mission</h3>
          <p>Identify the red flags in this interaction and respond appropriately. Look for warning signs and demonstrate safe online behavior.</p>
          
          <div class="guide-section">
            <strong>What to look for:</strong>
            <ul id="redFlagsList">
              <!-- Will be populated dynamically -->
            </ul>
          </div>

          <div class="guide-section">
            <strong>Good responses include:</strong>
            <ul>
              <li>Questioning suspicious requests or urgency</li>
              <li>Refusing to provide personal information</li>
              <li>Refusing to click links or send money</li>
              <li>Saying you'll verify independently or tell an adult</li>
              <li>Recognizing manipulation tactics</li>
            </ul>
          </div>

          <div class="flag-hint">
            üí° <strong>Tip:</strong> Think about what makes this interaction suspicious. What would you do in real life?
          </div>
        </div>

        <div id="detectionFeedback"></div>
      </div>

      <!-- Chat Messages -->
      <div class="chat-messages" id="messages">
        <!-- Messages appear here -->
      </div>

      <!-- Chat Input -->
      <div class="chat-input">
        <input 
          type="text" 
          id="messageInput" 
          placeholder="Type your response..." 
          autocomplete="off"
        >
        <button id="sendButton">Send</button>
        <button class="danger" id="finishButton">Finish Scenario</button>
      </div>
    </div>
  </main>

  <!-- Confirmation Modal -->
  <div class="modal" id="finishModal">
    <div class="modal-content">
      <h3>Ready to see your results?</h3>
      <p>You've exchanged <span id="modalMessageCount">0</span> messages and detected <span id="modalFlagCount">0</span> red flags.</p>
      <p>Are you ready to finish this scenario and see how you did?</p>
      <div class="modal-buttons">
        <button class="secondary" id="cancelFinish">Keep Practicing</button>
        <button id="confirmFinish">See Results</button>
      </div>
    </div>
  </div>

  <script src="js/api.js"></script>
  <script>
    let scenarioId = null;
    let adversaryName = 'Assistant';
    let isSending = false;
    let messageCount = 0;
    let detectedFlags = new Set();
    let totalFlags = 0;
    let requiredFlags = [];
    let guideVisible = true;

    function addMessage(who, text, name = null) {
      const messagesDiv = document.getElementById('messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${who}`;
      
      const label = document.createElement('span');
      label.className = 'label';
      label.textContent = who === 'user' ? 'You:' : `${name || adversaryName}:`;
      
      const content = document.createElement('div');
      content.className = 'content';
      content.textContent = text;
      
      messageDiv.appendChild(label);
      messageDiv.appendChild(content);
      messagesDiv.appendChild(messageDiv);
      
      // Smooth autoscroll
      messagesDiv.scrollTo({
        top: messagesDiv.scrollHeight,
        behavior: 'smooth'
      });
      
      if (who === 'user') {
        messageCount++;
        updateStats();
        checkForRedFlags(text);
      }
      
      return messageDiv;
    }

    function updateStats() {
      document.getElementById('messageCount').textContent = messageCount;
      document.getElementById('flagCount').textContent = `${detectedFlags.size}/${requiredFlags.length}`;
      
      // Update progress bar
      const progress = requiredFlags.length > 0 ? (detectedFlags.size / requiredFlags.length) * 100 : 0;
      document.getElementById('progressFill').style.width = `${progress}%`;
    }

    function checkForRedFlags(message) {
      const messageLower = message.toLowerCase();
      
      const flagKeywords = {
        "refuses_money": ["no money", "won't pay", "not sending", "can't afford", "won't give", "not giving", "refuse", "i won't"],
        "questions_personal_info": ["why do you need", "why personal", "suspicious", "why ssn", "why social security", "don't trust", "seems fake"],
        "questions_sender": ["who are you", "who is this", "verify", "prove", "real", "legitimate"],
        "refuses_to_click": ["won't click", "not clicking", "not opening", "won't open"],
        "tells_adult": ["tell parent", "tell teacher", "get help", "talk to adult", "ask parent"],
        "recognizes_manipulation": ["manipulating", "trying to trick", "scam", "not fair"],
        "verifies_independently": ["check myself", "look it up", "verify elsewhere", "call them", "research"],
        "questions_urgency": ["why urgent", "why now", "what happens if", "why hurry"],
        "checks_url": ["url", "link", "address", "domain"],
        "blocks_contact": ["block", "blocking", "stop contacting", "leave me alone"],
        "asks_for_proof": ["proof", "evidence", "show me"],
        "reports_phishing": ["report", "spam", "phishing"]
      };

      const newFlags = [];
      for (const flag of requiredFlags) {
        if (detectedFlags.has(flag)) continue;
        
        const keywords = flagKeywords[flag] || [];
        if (keywords.some(kw => messageLower.includes(kw))) {
          detectedFlags.add(flag);
          newFlags.push(flag);
        }
      }

      if (newFlags.length > 0) {
        showDetectionFeedback(newFlags);
        updateStats();
      }
    }

    function showDetectionFeedback(flags) {
      const container = document.getElementById('detectionFeedback');
      
      flags.forEach(flag => {
        const div = document.createElement('div');
        div.className = 'flag-detected';
        
        const flagName = flag.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        div.innerHTML = `‚úÖ <strong>Good catch!</strong> You demonstrated: ${flagName}`;
        
        container.appendChild(div);
        
        // Remove after 5 seconds
        setTimeout(() => {
          div.style.opacity = '0';
          setTimeout(() => div.remove(), 300);
        }, 5000);
      });
    }

    function updateLastMessage(chunk) {
      const messagesDiv = document.getElementById('messages');
      let lastMsg = messagesDiv.lastElementChild;
      
      if (!lastMsg || !lastMsg.classList.contains('bot') || lastMsg.dataset.complete) {
        lastMsg = document.createElement('div');
        lastMsg.className = 'message bot';
        
        const label = document.createElement('span');
        label.className = 'label';
        label.textContent = `${adversaryName}:`;
        
        const content = document.createElement('div');
        content.className = 'content';
        content.textContent = '';
        
        lastMsg.appendChild(label);
        lastMsg.appendChild(content);
        messagesDiv.appendChild(lastMsg);
      }
      
      const content = lastMsg.querySelector('.content');
      content.textContent += chunk;
      
      // Smooth autoscroll during streaming
      messagesDiv.scrollTo({
        top: messagesDiv.scrollHeight,
        behavior: 'smooth'
      });
    }

    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const sendButton = document.getElementById('sendButton');
      const text = input.value.trim();
      
      if (!text || isSending) return;
      
      isSending = true;
      sendButton.disabled = true;
      input.disabled = true;
      input.value = '';
      
      addMessage('user', text);
      
      try {
        const reader = await API.sendMessage(text);
        
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          
          const chunk = new TextDecoder().decode(value);
          updateLastMessage(chunk);
        }
        
        const lastMsg = document.getElementById('messages').lastElementChild;
        if (lastMsg) lastMsg.dataset.complete = 'true';
        
      } catch (error) {
        console.error('Send error:', error);
        const errorDiv = document.createElement('div');
        errorDiv.className = 'message system';
        errorDiv.textContent = '‚ö†Ô∏è Connection error. Please try again.';
        document.getElementById('messages').appendChild(errorDiv);
      } finally {
        isSending = false;
        sendButton.disabled = false;
        input.disabled = false;
        input.focus();
      }
    }

    function showFinishModal() {
      document.getElementById('modalMessageCount').textContent = messageCount;
      document.getElementById('modalFlagCount').textContent = detectedFlags.size;
      document.getElementById('finishModal').classList.add('show');
    }

    function hideFinishModal() {
      document.getElementById('finishModal').classList.remove('show');
    }

    async function finishScenario() {
      hideFinishModal();
      
      // Show loading state
      const finishBtn = document.getElementById('finishButton');
      finishBtn.textContent = 'Processing...';
      finishBtn.disabled = true;
      
      try {
        const results = await API.completeScenario();
        sessionStorage.setItem('scenarioResults', JSON.stringify(results));
        window.location.href = 'results.html';
      } catch (error) {
        console.error('Complete error:', error);
        finishBtn.textContent = 'Finish Scenario';
        finishBtn.disabled = false;
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'flag-hint';
        errorDiv.style.borderLeftColor = 'var(--danger)';
        errorDiv.innerHTML = '‚ö†Ô∏è <strong>Error:</strong> Failed to complete scenario. Please try again.';
        document.getElementById('detectionFeedback').appendChild(errorDiv);
      }
    }

    function toggleGuide() {
      guideVisible = !guideVisible;
      const guide = document.getElementById('scenarioGuide');
      guide.style.display = guideVisible ? 'block' : 'none';
    }

    async function init() {
      const params = new URLSearchParams(window.location.search);
      scenarioId = params.get('id');
      
      if (!scenarioId) {
        window.location.href = 'categories.html';
        return;
      }

      try {
        const scenario = await API.getScenario(scenarioId);
        document.getElementById('categoryName').textContent = `Training: ${scenario.category}`;
        document.title = `${scenario.title} - Cyber Safer`;
        
        // Set up red flags to watch for
        requiredFlags = scenario.success_criteria || [];
        totalFlags = (scenario.red_flags || []).length;
        
        // Populate guide
        const flagsList = document.getElementById('redFlagsList');
        requiredFlags.forEach(flag => {
          const li = document.createElement('li');
          li.textContent = flag.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
          flagsList.appendChild(li);
        });
        
        updateStats();
        
        // Start scenario
        const startData = await API.startScenario(scenarioId);
        adversaryName = startData.adversary || 'Assistant';
        
        if (startData.initial_message) {
          addMessage('bot', startData.initial_message, adversaryName);
        }
        
      } catch (error) {
        console.error('Init error:', error);
        document.getElementById('messages').innerHTML = 
          '<div class="message system">‚ö†Ô∏è Failed to load scenario. Please try again.</div>';
      }
      
      // Event listeners
      document.getElementById('sendButton').onclick = sendMessage;
      document.getElementById('finishButton').onclick = showFinishModal;
      document.getElementById('confirmFinish').onclick = finishScenario;
      document.getElementById('cancelFinish').onclick = hideFinishModal;
      document.getElementById('toggleGuide').onclick = toggleGuide;
      
      document.getElementById('messageInput').onkeypress = (e) => {
        if (e.key === 'Enter' && !isSending) sendMessage();
      };
      
      document.getElementById('messageInput').focus();
    }

    init();
  </script>
</body>
</html>
